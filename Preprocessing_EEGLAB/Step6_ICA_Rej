%%% Step6: IC rejection %%%

% Initialize EEGLAB
addpath('/mnt/raid/software/eeglab2024.1/')
eeglab

% Set relevant folders
input_folder = '/mnt/raid/RU1/Raw_data/Ettore/Studio_Rachi/Preprocessing_Output/Step5_Pre_ICA_Rej'
output_folder = '/mnt/raid/RU1/Raw_data/Ettore/Studio_Rachi/Preprocessing_Output/Step6_Post_ICA_Rej'

% Create output folder if it does not exist
if ~exist(output_folder, 'dir')
    mkdir(output_folder);
end

% Get file list
file_list = dir(fullfile(input_folder, '*.set'))

% Loop over files
for i = 1:length(file_list)

    file_name = file_list(i).name

    % Load dataset on EEGLAB
    EEG = pop_loadset('filename', file_name, 'filepath', input_folder)

    % Find flagged components indices
    rejected_components = find(EEG.reject.gcompreject)

    % Remove selected indices
    EEG = pop_subcomp(EEG, rejected_components, 0, 0)

    % Dave rejected components' indices in a .txt file
    csvwrite([output_folder, input_name(1:3), '_manually_rejected_components.txt'], rejected_components) % Save rejected indices
    [ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, 1, 'setname', [file_name '_icarej'])



end
